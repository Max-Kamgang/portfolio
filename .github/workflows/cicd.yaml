name: Real World Docker Build and Push 

on:
 push:
  branches: [ "main" ]
 pull_request:
  branches: [ "main" ]
permissions:
  id-token: write
  contents: read
env:
 python_version: '3.11'
 IMAGE_NAME: portcicd
 AWS_REGION: us-east-1
 ACCOUNT_ID: ${{secrets.ACCOUNT_ID}}
 ECR_REPO: ${{secrets.ACCOUNT_ID}}.dkr.ecr.${{secrets.AWS_REGION}}.amazonaws.com/portcicd
jobs: 
    pre-build:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v5
            - uses: actions/setup-python@v4
              with:
               python-version: ${{env.python_version}}
            - name: Install pytest
              run: pip install -r requirements.txt
            - name: Unit test 
              run: pytest test.py
            - name: Configure AWS credentials using OIDC
              uses: aws-actions/configure-aws-credentials@v2
              with:
               role-to-assume: ${{secrets.AWS_ROLE_ARN}}
               aws-region: ${{env.AWS_REGION}}
            - name: Check Credentials
              run: aws s3 ls
             
            - name: Login to Amazon ECR
              id: login-ecr
              uses: aws-actions/amazon-ecr-login@v1

      
            - name: Build Docker image
              run: |
                   docker build -t ${{ env.IMAGE_NAME }} .

      
            - name: Tag Docker image
              run: |
               docker tag ${{ env.IMAGE_NAME }}:latest ${{ env.ECR_REPO }}:latest
        # docker tag ${{ env.IMAGE_NAME }}:latest ${{ env.ECR_REPO }}:${{github.run_number}}

      
            - name: Scan Docker image with Trivy
              uses: aquasecurity/trivy-action@master
              with:
               image-ref: ${{ env.ECR_REPO }}:latest
               format: table
               exit-code: '0' # fail workflow on critical/high vulnerabilities
               severity: CRITICAL,HIGH

      # 7. Push Docker image to ECR
            - name: Push Docker image to Amazon ECR
              run: |
                docker push ${{ env.ECR_REPO }}:latest
    
    ecs_deploy:
        needs: pre-build
        runs-on: ubuntu-latest
        steps:
        - uses: actions/checkout@v4
        - name: Configure AWS credentials using OIDC
          uses: aws-actions/configure-aws-credentials@v2
          with:
            role-to-assume: ${{ secrets.ROLE_ARN }}
            aws-region: ${{ env.AWS_REGION }}
        - name: Render Amazon ECS task definition
          id: taskdef
          uses: aws-actions/amazon-ecs-render-task-definition@v1
          with:
            task-definition: ecs-taskdef.json
            container-name: nginx
            image: ${{ env.ECR_REPO }}:${{ env.IMAGE_TAG }}
        - name: Deploy to ECS Service
          uses: aws-actions/amazon-ecs-deploy-task-definition@v1
          with:
            task-definition: ${{ steps.taskdef.outputs.task-definition }}
            cluster: nginx-fargate-cluster
            service: nginx-fargate-service
            wait-for-service-stability: true
           

       